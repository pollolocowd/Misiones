<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compras</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .saldo {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .productos {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
      width: 200px;
    }
    .card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
    }
    button {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #codigoInput {
      margin-bottom: 20px;
    }
    #acceso {
      margin-bottom: 30px;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2MlMhFSi6zVx26tSCxQH_zf7DomtNtJE",
      authDomain: "banca-comisiones.firebaseapp.com",
      databaseURL: "https://banca-comisiones-default-rtdb.firebaseio.com/",
      projectId: "banca-comisiones",
      storageBucket: "banca-comisiones.appspot.com",
      messagingSenderId: "13645114022",
      appId: "1:13645114022:web:c69d46b83b12cf20cb6267"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUserKey = "";
    let currentSaldo = 0;

    window.comprar = async function(monto, index) {
      if (currentSaldo < monto) {
        alert("Saldo insuficiente");
        return;
      }
      currentSaldo -= monto;
      await update(ref(db, "usuarios/" + currentUserKey), { saldo: currentSaldo });
      document.getElementById("saldo").innerText = "Saldo: $" + currentSaldo;
      document.getElementById("comprarBtn" + index).style.display = "none";
      document.getElementById("reembolsarBtn" + index).style.display = "inline-block";
    }

    
    window.reembolsar = async function(monto, index) {
      // Crear solicitud de reembolso pendiente
      const solicitudId = Date.now();
      await update(ref(db, `reembolsos/${currentUserKey}/${solicitudId}`), {
        monto: monto,
        producto: document.querySelectorAll(".card h3")[index].innerText,
        estado: "pendiente"
      });

      alert("Tu solicitud de reembolso ha sido enviada. Espera aprobación del administrador.");
      document.getElementById("comprarBtn" + index).style.display = "inline-block";
      document.getElementById("reembolsarBtn" + index).style.display = "none";
    
      currentSaldo += monto;
      await update(ref(db, "usuarios/" + currentUserKey), { saldo: currentSaldo });
      document.getElementById("saldo").innerText = "Saldo: $" + currentSaldo;
      document.getElementById("comprarBtn" + index).style.display = "inline-block";
      document.getElementById("reembolsarBtn" + index).style.display = "none";
    }

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("accederBtn").addEventListener("click", async () => {
        const codigo = document.getElementById("codigoInput").value.trim();
        const snapshot = await get(ref(db, "usuarios/" + codigo));
        if (snapshot.exists()) {
          const data = snapshot.val();
          currentUserKey = codigo;
          currentSaldo = data.saldo || 0;
          document.getElementById("saldo").innerText = "Saldo: $" + currentSaldo;
          document.getElementById("acceso").style.display = "none";
          document.getElementById("contenido").style.display = "block";
        } else {
          alert("Código inválido");
        }
      });
    });
  </script>
</head>
<body>
  <div id="acceso">
    <h2>Acceso por Código</h2>
    <input type="text" id="codigoInput" placeholder="Código de acceso" />
    <br>
    <button id="accederBtn">Acceder</button>
  </div>

  <div id="contenido" style="display:none;">
    <div class="saldo" id="saldo">Saldo: $0</div>
    <div class="productos">
      
    <div class="card">
      <img src="https://i.postimg.cc/TYFj4bM5/audifonos.jpg" alt="Audífonos inalámbricos" />
      <h3>Audífonos inalámbricos</h3>
      <p>Precio: $150</p>
      <button onclick="comprar(150, 0)" id="comprarBtn0">Comprar</button>
      <button onclick="reembolsar(150, 0)" id="reembolsarBtn0" style="display:none;">Reembolsar</button>
    </div>
    
    <div class="card">
      <img src="https://i.postimg.cc/MH6W44r5/camisa.jpg" alt="Camisa deportiva" />
      <h3>Camisa deportiva</h3>
      <p>Precio: $100</p>
      <button onclick="comprar(100, 1)" id="comprarBtn1">Comprar</button>
      <button onclick="reembolsar(100, 1)" id="reembolsarBtn1" style="display:none;">Reembolsar</button>
    </div>
    
    <div class="card">
      <img src="https://i.postimg.cc/15Vyjc0s/powerbank.jpg" alt="Powerbank 10000mAh" />
      <h3>Powerbank 10000mAh</h3>
      <p>Precio: $70</p>
      <button onclick="comprar(70, 2)" id="comprarBtn2">Comprar</button>
      <button onclick="reembolsar(70, 2)" id="reembolsarBtn2" style="display:none;">Reembolsar</button>
    </div>
    
    <div class="card">
      <img src="https://i.postimg.cc/L8Z7CbZq/bocina.jpg" alt="Mini bocina Bluetooth" />
      <h3>Mini bocina Bluetooth</h3>
      <p>Precio: $200</p>
      <button onclick="comprar(200, 3)" id="comprarBtn3">Comprar</button>
      <button onclick="reembolsar(200, 3)" id="reembolsarBtn3" style="display:none;">Reembolsar</button>
    </div>
    
    <div class="card">
      <img src="https://i.postimg.cc/zDcHZ0S4/smartwatch.jpg" alt="Smartwatch básico" />
      <h3>Smartwatch básico</h3>
      <p>Precio: $500</p>
      <button onclick="comprar(500, 4)" id="comprarBtn4">Comprar</button>
      <button onclick="reembolsar(500, 4)" id="reembolsarBtn4" style="display:none;">Reembolsar</button>
    </div>
    
    </div>
  </div>
</body>
</html>
